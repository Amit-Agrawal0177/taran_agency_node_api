<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Arctic-Geese Video Stream</title>
  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
      color: #ffffff;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }

    /* Animated background particles */
    .particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }

    .particle {
      position: absolute;
      width: 6px;
      height: 6px;
      background: rgba(255, 75, 75, 0.6);
      border-radius: 50%;
      animation: float 6s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.5; }
      50% { transform: translateY(-20px) rotate(180deg); opacity: 1; }
    }

    /* Header */
    .header {
      position: relative;
      z-index: 10;
      text-align: center;
      padding: 2rem 1rem;
      background: rgba(10, 10, 10, 0.3);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 75, 75, 0.2);
    }

    .logo {
      font-size: clamp(2.5rem, 6vw, 4rem);
      font-weight: 800;
      background: linear-gradient(135deg, #ff4b4b, #ff8e8e, #ff4b4b);
      background-size: 200% 200%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: gradientShift 3s ease-in-out infinite;
      text-shadow: 0 0 30px rgba(255, 75, 75, 0.5);
      margin-bottom: 0.5rem;
    }

    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .subtitle {
      font-size: 1.2rem;
      color: rgba(255, 255, 255, 0.7);
      font-weight: 300;
      letter-spacing: 2px;
    }

    /* Main container */
    .container {
      position: relative;
      z-index: 10;
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* Video container */
    .video-container {
      position: relative;
      width: 100%;
      max-width: 1200px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 20px;
      padding: 1.5rem;
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 75, 75, 0.3);
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.3),
        0 0 40px rgba(255, 75, 75, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      margin-bottom: 2rem;
    }

    .video-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .stream-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #ffffff;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 25px;
      background: rgba(255, 75, 75, 0.1);
      border: 1px solid rgba(255, 75, 75, 0.3);
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #ff4b4b;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }

    .status-dot.connected {
      background: #4bff4b;
    }

    .status-dot.disconnected {
      background: #ffaa4b;
      animation: none;
    }

    /* Video frame */
    .video-wrapper {
      position: relative;
      width: 100%;
      min-height: 400px;
      border-radius: 15px;
      overflow: hidden;
      background: linear-gradient(45deg, #1a1a1a, #2a2a2a);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #videoFrame {
      width: 100%;
      height: auto;
      max-height: 70vh;
      object-fit: contain;
      border-radius: 15px;
      transition: all 0.3s ease;
    }

    .loading-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: rgba(255, 255, 255, 0.6);
      font-size: 1.2rem;
      z-index: 5;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255, 75, 75, 0.3);
      border-top: 3px solid #ff4b4b;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Stats panel */
    .stats-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      width: 100%;
      max-width: 1200px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      padding: 1.5rem;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 75, 75, 0.2);
      text-align: center;
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(255, 75, 75, 0.2);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: #ff4b4b;
      margin-bottom: 0.5rem;
    }

    .stat-label {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.7);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Controls */
    .controls {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
      flex-wrap: wrap;
      justify-content: center;
    }

    .control-btn {
      padding: 0.8rem 1.5rem;
      background: linear-gradient(135deg, #ff4b4b, #ff6b6b);
      border: none;
      border-radius: 25px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(255, 75, 75, 0.3);
    }

    .control-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 75, 75, 0.4);
    }

    .control-btn:active {
      transform: translateY(0);
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }
      
      .video-container {
        padding: 1rem;
      }

      .video-header {
        flex-direction: column;
        text-align: center;
      }

      .stats-panel {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .controls {
        flex-direction: column;
        align-items: center;
      }

      .control-btn {
        width: 200px;
      }
    }

    /* Fullscreen styles */
    .fullscreen-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(0, 0, 0, 0.7);
      border: none;
      color: white;
      padding: 0.5rem;
      border-radius: 5px;
      cursor: pointer;
      z-index: 10;
    }

    .floating-logo {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 100;
      opacity: 0.6;
      transition: all 0.3s ease;
    }

    .floating-logo:hover {
      opacity: 1;
      transform: scale(1.1);
    }

    .floating-logo img {
      height: 40px;
      width: auto;
      filter: drop-shadow(0 0 8px rgba(255, 75, 75, 0.4));
    }
  </style>
</head>
<body>
  <!-- Animated background particles -->
  <div class="particles" id="particles"></div>

  <div class="floating-logo">
    <img src="https://arctic-geese.s3.ap-south-1.amazonaws.com/Agrawal's_420_Papad/AG_Logo_large+(2).png" alt="Arctic Geese" />
  </div>

  <!-- Header -->
  <header class="header">
    <h1 class="logo">üö® ARCTIC-GEESE</h1>
    <p class="subtitle">  LIVE VIDEO SURVEILLANCE</p>
  </header>

  <!-- Main container -->
  <div class="container">
    <!-- Video container -->
    <div class="video-container">
      <div class="video-header">
        <h2 class="stream-title">Live Feed - Agrawal Station</h2>
        <div class="status-indicator">
          <div class="status-dot" id="statusDot"></div>
          <span id="statusText">Connecting...</span>
        </div>
      </div>
      
      <div class="video-wrapper">
        <div class="loading-message" id="loadingMessage">
          <div class="loading-spinner"></div>
          <div>Establishing connection...</div>
        </div>
        <img id="videoFrame" alt="Video Stream" style="display: none;" />
        <button class="fullscreen-btn" onclick="toggleFullscreen()" title="Fullscreen">‚õ∂</button>
      </div>
    </div>

    <!-- Stats panel -->
    <div class="stats-panel">
      <div class="stat-card">
        <div class="stat-value" id="frameCount">0</div>
        <div class="stat-label">Frames Received</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="fps">0</div>
        <div class="stat-label">FPS</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="uptime">00:00</div>
        <div class="stat-label">Connection Time</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="quality">HD</div>
        <div class="stat-label">Stream Quality</div>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <button class="control-btn" onclick="reconnect()">üîÑ Reconnect</button>
      <button class="control-btn" onclick="toggleStream()">‚è∏Ô∏è Pause</button>
      <button class="control-btn" onclick="captureFrame()">üì∏ Capture</button>
    </div>
  </div>

  <script>
    // Socket connection
    const socket = io('https://www.arctic-geese.com', {
      path: '/socket.io/',
      transports: ['websocket', 'polling'],
      secure: true,
      timeout: 20000,
      forceNew: true
    });

    // DOM elements
    const videoElement = document.getElementById('videoFrame');
    const loadingMessage = document.getElementById('loadingMessage');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const frameCountEl = document.getElementById('frameCount');
    const fpsEl = document.getElementById('fps');
    const uptimeEl = document.getElementById('uptime');
    
    // State variables
    let frameCount = 0;
    let startTime = Date.now();
    let lastFrameTime = 0;
    let fps = 0;
    let isPaused = false;
    let connectionTime = 0;

    // Create animated particles
    function createParticles() {
      const particlesContainer = document.getElementById('particles');
      for (let i = 0; i < 50; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.top = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 6 + 's';
        particle.style.animationDuration = (Math.random() * 4 + 4) + 's';
        particlesContainer.appendChild(particle);
      }
    }

    // socket.on('connect', () => {
    //   console.log("üì° Socket connected, subscribing...");
    //   socket.emit('subscribe', 'I/Agrawal_video');
    //   socket.emit('publish', {
    //     topic: 'R/Agrawal_papad',
    //     message: 'Start Streaming'
    //   });

    //   // Publish every 30 seconds
    //   setInterval(() => {
    //     socket.emit('publish', {
    //       topic: 'R/Agrawal_papad',
    //       message: 'Start Streaming'
    //     });
    //     console.log("üì§ Published 'Start Streaming' to R/Agrawal_papad");
    //   }, 30000);
    // });

    // Socket event handlers
    socket.on('connect', () => {
      console.log("üì° Socket connected, subscribing...");
      statusDot.className = 'status-dot connected';
      statusText.textContent = 'Connected';
      socket.emit('subscribe', 'I/Agrawal_video');
      socket.emit('publish', {
        topic: 'R/Agrawal_papad',
        message: 'Start Streaming'
      });

      // Publish every 30 seconds
      setInterval(() => {
        socket.emit('publish', {
          topic: 'R/Agrawal_papad',
          message: 'Start Streaming'
        });
        console.log("üì§ Published 'Start Streaming' to R/Agrawal_papad");
      }, 30000);
      startTime = Date.now();
    });

    socket.on('disconnect', () => {
      console.log("üì° Socket disconnected");
      statusDot.className = 'status-dot disconnected';
      statusText.textContent = 'Disconnected';
      loadingMessage.style.display = 'block';
      videoElement.style.display = 'none';
    });

    socket.on('mqttMessage', function (data) {
      if (isPaused) return;
      if(data.topic != "I/Agrawal_video") return;
      
      try {
        let imageData;
        const parsed = JSON.parse(data.message);
        if (parsed.data) {
          imageData = parsed.data;
        } else {
          imageData = data.message;
        }
        
        if (imageData && imageData.length > 100) {
          videoElement.src = 'data:image/jpeg;base64,' + imageData;
          videoElement.style.display = 'block';
          loadingMessage.style.display = 'none';
          
          // Update stats
          frameCount++;
          frameCountEl.textContent = frameCount;
          
          // Calculate FPS
          const now = Date.now();
          if (lastFrameTime > 0) {
            const timeDiff = (now - lastFrameTime) / 1000;
            fps = Math.round(1 / timeDiff);
            fpsEl.textContent = fps;
          }
          lastFrameTime = now;
        }
      } catch (e) {
        console.error('Error processing frame:', e);
      }
    });

    // Update connection time
    setInterval(() => {
      if (socket.connected) {
        connectionTime = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(connectionTime / 60);
        const seconds = connectionTime % 60;
        uptimeEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }
    }, 1000);

    // Control functions
    function reconnect() {
      socket.disconnect();
      socket.connect();
      frameCount = 0;
      frameCountEl.textContent = '0';
    }

    function toggleStream() {
      isPaused = !isPaused;
      const btn = event.target;
      btn.textContent = isPaused ? '‚ñ∂Ô∏è Resume' : '‚è∏Ô∏è Pause';
    }

    function captureFrame() {
      if (videoElement.src) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = videoElement.naturalWidth;
        canvas.height = videoElement.naturalHeight;
        ctx.drawImage(videoElement, 0, 0);
        
        // Download the image
        const link = document.createElement('a');
        link.download = `arctic-geese-capture-${Date.now()}.png`;
        link.href = canvas.toDataURL();
        link.click();
      }
    }

    function toggleFullscreen() {
      const videoWrapper = document.querySelector('.video-wrapper');
      if (!document.fullscreenElement) {
        videoWrapper.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    }

    // Initialize
    createParticles();
  </script>
</body>
</html>